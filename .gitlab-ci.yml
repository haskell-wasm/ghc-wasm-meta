default:
  interruptible: true

workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PROJECT_NAMESPACE == "haskell-wasm"

variables:
  DOCKER_REV: eb4d3389fd62e4f7321a0c8799014ec1f4da0708
  GIT_DEPTH: 1
  GIT_STRATEGY: clone

.x86_64-linux-ubuntu:
  tags:
    - x86_64-linux
  image: registry.gitlab.haskell.org/ghc/ci-images/x86_64-linux-ubuntu24_04:$DOCKER_REV
  before_script:
    - |
      sudo apt update
      sudo apt install -y \
        zstd
    - sudo chown ghc:ghc -R .
    - |
      PREFIX=/tmp/.ghc-wasm ./setup.sh
      sed -i -e "s/\$ncpus/$CPUS/" /tmp/.ghc-wasm/.cabal/config
      . /tmp/.ghc-wasm/env

.x86_64-linux-ubuntu-head:
  extends: .x86_64-linux-ubuntu
  script:
    - ./tests/ghci.sh
    - ./tests/agda.sh
    - ./tests/misc.sh
    - ./tests/miso-ormolu.sh
    - ./tests/pandoc.sh

x86_64-linux-ubuntu-gmp:
  extends: .x86_64-linux-ubuntu-head
  variables:
    FLAVOUR: gmp

x86_64-linux-ubuntu-native:
  extends: .x86_64-linux-ubuntu-head
  variables:
    FLAVOUR: native

x86_64-linux-ubuntu-unreg:
  extends: .x86_64-linux-ubuntu-head
  variables:
    FLAVOUR: unreg

x86_64-linux-ubuntu-9.6:
  extends: .x86_64-linux-ubuntu
  variables:
    FLAVOUR: "9.6"
  script:
    - ./tests/agda.sh
    - ./tests/misc.sh

x86_64-linux-ubuntu-9.8:
  extends: .x86_64-linux-ubuntu
  variables:
    FLAVOUR: "9.8"
  script:
    - ./tests/agda.sh
    - ./tests/misc.sh

x86_64-linux-ubuntu-9.10:
  extends: .x86_64-linux-ubuntu
  variables:
    FLAVOUR: "9.10"
  script:
    - ./tests/ghci.sh
    - ./tests/agda.sh
    - ./tests/humblr.sh
    - ./tests/misc.sh
    - ./tests/miso-ormolu.sh
    - ./tests/pandoc.sh

x86_64-linux-ubuntu-9.12:
  extends: .x86_64-linux-ubuntu
  variables:
    FLAVOUR: "9.12"
  script:
    - ./tests/ghci.sh
    - ./tests/agda.sh
    - ./tests/humblr.sh
    - ./tests/misc.sh
    - ./tests/miso-ormolu.sh
    - ./tests/pandoc.sh

.nix:
  script:
    - |
      nix shell nixpkgs#autoconf nixpkgs#dart-sass nixpkgs#gawk nixpkgs#gnused .#$NIX_FLAVOUR --command bash -euo pipefail -c 'export CROSS_EMULATOR=$CI_PROJECT_DIR/wasm-run/wasm-run.mjs && wasm32-wasi-cabal update --ignore-project && sed -i -e "s/\$ncpus/$CPUS/" $HOME/.ghc-wasm/.cabal/config && ./tests/ghci.sh && ./tests/agda.sh && ./tests/misc.sh && ./tests/miso-ormolu.sh && ./tests/pandoc.sh'

.linux-nix:
  extends: .nix
  image: nixos/nix:2.25.2
  before_script:
    - echo "experimental-features = nix-command flakes" >> /etc/nix/nix.conf
    - echo "cores = $CPUS" >> /etc/nix/nix.conf
    - echo "max-jobs = $CPUS" >> /etc/nix/nix.conf

aarch64-linux-nix-gmp:
  extends: .linux-nix
  tags:
    - aarch64-linux
  variables:
    FLAVOUR: gmp
    NIX_FLAVOUR: all_gmp

.darwin-nix:
  extends: .nix
  before_script:
    - export HOME=$(mktemp -d)

aarch64-darwin-nix-9.12:
  extends: .darwin-nix
  tags:
    - aarch64-darwin
  variables:
    FLAVOUR: "9.12"
    NIX_FLAVOUR: all_9_12

aarch64-darwin-nix-9.10:
  extends: .darwin-nix
  tags:
    - aarch64-darwin
  variables:
    FLAVOUR: "9.10"
    NIX_FLAVOUR: all_9_10
